{% extends 'partials/layout-vertical.html.twig' %}

{% block title %}Nouvelle mission{% endblock %}

{% block topbar %}
    {{ include('partials/topbar.html.twig', {
        page_title: 'Créer une nouvelle mission',
        breadcrumb: [
            { label: 'Projets', path: path('gs-projet_project_index') },
            { label: 'Missions', path: path('gs-projet_project_missions_index', {'id': project.id}) },
            { label: 'Créer' }
        ]
    }) }}
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Formulaire de création</h4>
                <p class="sub-header">Tous les champs marqués d'une astérisque (*) sont obligatoires</p>

                {{ include('gs-projet/project/_formMiss.html.twig', {form: form, project: project}) }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="/libs/flatpickr/flatpickr.min.css">
    <!-- Ajout de Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script src="/libs/parsleyjs/parsley.min.js"></script>
    <script src="/libs/parsleyjs/i18n/fr.js"></script>
    <script src="/libs/flatpickr/flatpickr.min.js"></script>
    <script src="/libs/flatpickr/l10n/fr.js"></script>
    <!-- Ajout de Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/fr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            // Configuration Flatpickr
            flatpickr('.flatpickr', {
                dateFormat: 'd/m/Y',
                locale: 'fr',
                allowInput: true,
                minDate: 'today'
            });

            // Configuration Select2 pour le champ assignedTo
            $('#assigned-to-select').select2({
                theme: 'bootstrap-5',
                placeholder: 'Sélectionnez un utilisateur',
                allowClear: true,
                language: 'fr',
                matcher: function(params, data) {
                    // Affiche tous les résultats si la recherche est vide
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    
                    // Vérifie si le texte commence par la recherche (case insensitive)
                    if (data.text.toUpperCase().indexOf(params.term.toUpperCase()) === 0) {
                        return data;
                    }
                    
                    return null;
                }
            });

            // Configuration Parsley
            window.Parsley.addValidator('dateAfter', {
                validateString: function (value) {
                    const parts = value.split('/');
                    const selectedDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    return selectedDate > today;
                },
                messages: {
                    fr: "La date doit être postérieure à aujourd'hui"
                }
            });

            $('form').parsley({
                errorClass: 'is-invalid',
                successClass: 'is-valid',
                errorsWrapper: '<div class="invalid-feedback"></div>',
                errorTemplate: '<span></span>'
            });

            window.Parsley.setLocale('fr');

            // Gestion des alertes SweetAlert
            {% if showSuccessAlert %}
                Swal.fire({
                    title: 'Mission créée avec succès',
                    text: 'La mission a été ajoutée au projet.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = "{{ path('gs-projet_project_show', {'id': project.id}) }}";
                });
            {% endif %}
        });
    </script>
{% endblock %}