{% extends 'partials/layout-horizontal.html.twig' %}

{% block title %}Réservation de trajets{% endblock %}

{% block topbar %}
    {{ include('partials/topbar.html.twig', { page_title: 'Réservation de trajets' }) }}
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Bouton Mes Réservations -->
                <div class="mb-3">
                    <button class="btn btn-info" id="showReservationsBtn">
                        <i class="mdi mdi-calendar-text me-1"></i> Mes Réservations
                    </button>
                </div>

                <!-- Barre de recherche -->
                <div class="row mb-3">
                    <div class="col-md-5">
                        <input type="text" id="depart" class="form-control" placeholder="Point de départ" required>
                    </div>
                    <div class="col-md-5">
                        <input type="text" id="arrive" class="form-control" placeholder="Point d'arrivée" required>
                    </div>
                    <div class="col-md-2">
                        <button id="searchBtn" class="btn btn-primary w-100">
                            <i class="mdi mdi-magnify me-1"></i> Rechercher
                        </button>
                    </div>
                </div>

                <!-- Résultats -->
                <div id="resultsContainer">
                    <div class="alert alert-info">
                        Veuillez entrer au moins un point de départ ou d'arrivée
                    </div>
                </div>

                <!-- Section Mes Réservations (cachée par défaut) -->
                <div id="myReservationsContainer" style="display: none;">
                    <h4 class="mb-3">Mes Réservations</h4>
                    <div id="reservationsList">
                        <!-- Le contenu sera chargé via AJAX -->
                        <div class="alert alert-info">Chargement en cours...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la recherche
    document.getElementById('searchBtn').addEventListener('click', function() {
        const depart = document.getElementById('depart').value;
        const arrive = document.getElementById('arrive').value;

        if (!depart && !arrive) {
            alert('Veuillez entrer au moins un point de départ ou d\'arrivée');
            return;
        }

        // Masquer les réservations et montrer les résultats
        document.getElementById('myReservationsContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';

        fetch(`{{ path('app_transport_reservation_search') }}?depart=${encodeURIComponent(depart)}&arrive=${encodeURIComponent(arrive)}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('resultsContainer').innerHTML = html;
            });
    });

    // Bouton "Mes Réservations"
    document.getElementById('showReservationsBtn').addEventListener('click', function() {
        const container = document.getElementById('myReservationsContainer');
        const isVisible = container.style.display !== 'none';
        
        if (!isVisible) {
            // Charger les réservations via AJAX
            fetch('{{ path("app_transport_reservation_list") }}')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('reservationsList').innerHTML = html;
                    container.style.display = 'block';
                    document.getElementById('resultsContainer').style.display = 'none';
                });
        } else {
            container.style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
        }
    });

    // Optionnel: permettre la recherche avec la touche Entrée
    ['depart', 'arrive'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });
    });
});

function deleteReservation(reservationId) {
    if (confirm('Êtes-vous sûr de vouloir annuler cette réservation ?')) {
        // Afficher un indicateur de chargement
        const button = event.target;
        button.disabled = true;
        button.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Traitement...';

        fetch(`/transport/reservation/${reservationId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                '_token': '{{ csrf_token('delete_reservation') }}'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Recharger la liste
                document.getElementById('showReservationsBtn').click();
                // Afficher notification
                showAlert('success', 'Réservation annulée avec succès');
            } else {
                throw new Error(data.error || 'Erreur inconnue');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('danger', `Échec de l'annulation: ${error.message}`);
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '<i class="mdi mdi-delete"></i> Annuler';
        });
    }
}

function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    const container = document.getElementById('myReservationsContainer');
    container.prepend(alert);
    
    // Fermeture automatique après 5s
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
    }, 5000);
}
</script>
{% endblock %}